@page "/generate-video"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using VideoGenerationApp.Services
@using VideoGenerationApp.Services.Generation
@using VideoGenerationApp.Dto
@inject VideoGenerationWorkflow VideoWorkflow
@inject IGeneratedFileService FileService
@inject IGenerationQueueService QueueService
@inject OllamaOutputState OutputState
@inject ILogger<GenerateVideo> Logger
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Generate Video - Video Generation App</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="bi bi-camera-video me-2"></i>
                Generate Video
            </h3>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Error:</strong> @errorMessage
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <!-- Model Set Configuration Section -->
            <div class="parameter-section">
                <h5><i class="bi bi-cpu me-2"></i>Model Configuration</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="modelSet">
                                Model Set
                                <i class="bi bi-question-circle tooltip-icon" title="Select the model configuration set. Each set contains compatible models optimized for specific use cases."></i>
                            </label>
                            <select id="modelSet" class="form-select" @bind="videoWrapper.ModelSet" @bind:after="OnModelSetChanged">
                                @foreach (var modelSet in VideoWorkflowWrapper.GetAvailableModelSets())
                                {
                                    <option value="@modelSet.Key">@modelSet.Value.DisplayName</option>
                                }
                            </select>
                            <small class="form-text text-muted">
                                <strong>Current Models:</strong> @GetCurrentModelInfo()
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="modelSamplingShift">
                                Model Sampling Shift
                                <i class="bi bi-question-circle tooltip-icon" title="SD3 model sampling shift parameter (1-15)"></i>
                            </label>
                            <input id="modelSamplingShift" type="number" class="form-control" step="0.1" min="1" max="15" 
                                @bind="videoWrapper.ModelSamplingShift" />
                        </div>
                        
                        <div class="form-group">
                            <label for="loraStrength">
                                LoRA Strength
                                <i class="bi bi-question-circle tooltip-icon" title="Strength of LoRA model influence (0.0-2.0, only applies to Lightning model sets)"></i>
                            </label>
                            <input id="loraStrength" type="number" class="form-control" step="0.1" min="0" max="2" 
                                @bind="videoWrapper.LoRAStrength" disabled="@(GetCurrentModelSet().LoRAModel == null)" />
                            @if (GetCurrentModelSet().LoRAModel == null)
                            {
                                <small class="form-text text-muted">No LoRA in current model set</small>
                            }
                            else
                            {
                                <small class="form-text text-muted">Using: @GetCurrentModelSet().LoRAModel</small>
                            }
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-info-circle me-2"></i>Current Model Set Details</h6>
                            <small>
                                <strong>UNet:</strong> @GetCurrentModelSet().UNetModel<br/>
                                <strong>CLIP:</strong> @GetCurrentModelSet().CLIPModel<br/>
                                <strong>VAE:</strong> @GetCurrentModelSet().VAEModel<br/>
                                <strong>Audio Encoder:</strong> @GetCurrentModelSet().AudioEncoderModel<br/>
                                @if (!string.IsNullOrEmpty(GetCurrentModelSet().LoRAModel))
                                {
                                    <strong>LoRA:</strong> @GetCurrentModelSet().LoRAModel<br/>
                                }
                                <strong>Recommended:</strong> @GetCurrentModelSet().DefaultSteps steps, CFG @GetCurrentModelSet().DefaultCFG
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video Configuration Section -->
            <div class="parameter-section">
                <h5><i class="bi bi-camera-video me-2"></i>Video Generation Configuration</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="textPrompt">
                                Text Prompt / Description
                                <i class="bi bi-question-circle tooltip-icon" title="Describe what should happen in the video"></i>
                            </label>
                            <textarea id="textPrompt" class="form-control" rows="4" @bind="videoWrapper.TextPrompt" 
                                placeholder="e.g., A serene landscape with moving clouds and gentle wind"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="negativePrompt">
                                Negative Prompt
                                <i class="bi bi-question-circle tooltip-icon" title="Describe what you don't want in the video"></i>
                            </label>
                            <textarea id="negativePrompt" class="form-control" rows="2" @bind="videoWrapper.NegativePrompt" 
                                placeholder="e.g., blurry, low quality, distorted, ugly"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="audioFile">
                                Audio File (optional)
                                <i class="bi bi-question-circle tooltip-icon" title="Select an audio file from previous generations"></i>
                            </label>
                            <select id="audioFile" class="form-control" @bind="videoWrapper.AudioFilePath">
                                <option value="">-- No Audio --</option>
                                @foreach (var file in audioFiles)
                                {
                                    <option value="@file.FilePath">@file.DisplayText</option>
                                }
                            </select>
                            @if (audioFiles.Any())
                            {
                                <small class="form-text text-muted">@audioFiles.Count audio file(s) available</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="imageFile">
                                Base Image (optional)
                                <i class="bi bi-question-circle tooltip-icon" title="Select an image file from previous generations"></i>
                            </label>
                            <select id="imageFile" class="form-control" @bind="videoWrapper.ImageFilePath" @bind:after="OnImageSelectionChanged">
                                <option value="">-- Generate from prompt --</option>
                                @foreach (var file in imageFiles)
                                {
                                    <option value="@file.FilePath">@file.DisplayText</option>
                                }
                            </select>
                            @if (imageFiles.Any())
                            {
                                <small class="form-text text-muted">@imageFiles.Count image file(s) available</small>
                            }
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="width">
                                Width
                                <i class="bi bi-question-circle tooltip-icon" title="Video width in pixels (must be divisible by 64)"></i>
                            </label>
                            <input id="width" type="number" class="form-control" step="64" min="512" max="2048" 
                                @bind="videoWrapper.Width" />
                            @if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
                            {
                                <small class="form-text text-muted">Matches selected image width</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="height">
                                Height
                                <i class="bi bi-question-circle tooltip-icon" title="Video height in pixels (must be divisible by 64)"></i>
                            </label>
                            <input id="height" type="number" class="form-control" step="64" min="512" max="2048" 
                                @bind="videoWrapper.Height" />
                            @if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
                            {
                                <small class="form-text text-muted">Matches selected image height</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="videoSegments">
                                Video Segments
                                <i class="bi bi-question-circle tooltip-icon" title="Number of video segments to generate (more segments = longer video)"></i>
                            </label>
                            <input id="videoSegments" type="number" class="form-control" min="1" max="10" 
                                @bind="videoWrapper.VideoSegments" />
                            <small class="form-text text-muted">
                                Total frames: @videoWrapper.TotalFrames | Batch size: @videoWrapper.BatchSize
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <label for="chunkLength">
                                Chunk Length
                                <i class="bi bi-question-circle tooltip-icon" title="Frames per segment (77 is recommended, minimum 73)"></i>
                            </label>
                            <input id="chunkLength" type="number" class="form-control" min="73" max="154" 
                                @bind="videoWrapper.ChunkLength" />
                            <small class="form-text text-muted">Higher values may cause out-of-memory issues</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="fps">
                                Output FPS
                                <i class="bi bi-question-circle tooltip-icon" title="Frames per second for the output video"></i>
                            </label>
                            <select id="fps" class="form-control" @bind="videoWrapper.Fps">
                                <option value="8">8 FPS (Slow)</option>
                                <option value="16">16 FPS (Standard)</option>
                                <option value="24">24 FPS (Film)</option>
                                <option value="30">30 FPS (Smooth)</option>
                            </select>
                            <small class="form-text text-muted">
                                Estimated duration: @GetEstimatedDuration() seconds
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sampling Configuration Section -->
            <div class="parameter-section">
                <h5><i class="bi bi-sliders me-2"></i>Sampling Configuration</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="steps">
                                Generation Steps
                                <i class="bi bi-question-circle tooltip-icon" title="Number of denoising steps (higher = better quality, slower)"></i>
                            </label>
                            <input id="steps" type="number" class="form-control" min="1" max="100" 
                                @bind="videoWrapper.Steps" />
                            <small class="form-text text-muted">Recommended: @GetCurrentModelSet().DefaultSteps for current model set</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="cfgScale">
                                CFG Scale
                                <i class="bi bi-question-circle tooltip-icon" title="How closely to follow the prompt (0.1-20)"></i>
                            </label>
                            <input id="cfgScale" type="number" class="form-control" step="0.1" min="0.1" max="20" 
                                @bind="videoWrapper.CFGScale" />
                            <small class="form-text text-muted">Recommended: @GetCurrentModelSet().DefaultCFG for current model set</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="seed">
                                Seed
                                <i class="bi bi-question-circle tooltip-icon" title="Random seed for reproducible results (-1 for random)"></i>
                            </label>
                            <input id="seed" type="number" class="form-control" @bind="videoWrapper.Seed" />
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="samplerName">
                                Sampler
                                <i class="bi bi-question-circle tooltip-icon" title="Sampling method used for generation"></i>
                            </label>
                            <select id="samplerName" class="form-select" @bind="videoWrapper.SamplerName">
                                <option value="euler">Euler</option>
                                <option value="euler_ancestral">Euler Ancestral</option>
                                <option value="heun">Heun</option>
                                <option value="dpm_2">DPM2</option>
                                <option value="dpm_2_ancestral">DPM2 Ancestral</option>
                                <option value="lms">LMS</option>
                                <option value="dpm_fast">DPM Fast</option>
                                <option value="dpm_adaptive">DPM Adaptive</option>
                                <option value="dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                                <option value="dpmpp_sde">DPM++ SDE</option>
                                <option value="dpmpp_2m">DPM++ 2M</option>
                                <option value="ddim">DDIM</option>
                                <option value="uni_pc">UniPC</option>
                            </select>
                            <small class="form-text text-muted">Recommended: @GetCurrentModelSet().RecommendedSampler</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="scheduler">
                                Scheduler
                                <i class="bi bi-question-circle tooltip-icon" title="Noise schedule used during generation"></i>
                            </label>
                            <select id="scheduler" class="form-select" @bind="videoWrapper.Scheduler">
                                <option value="normal">Normal</option>
                                <option value="karras">Karras</option>
                                <option value="exponential">Exponential</option>
                                <option value="sgm_uniform">SGM Uniform</option>
                                <option value="simple">Simple</option>
                                <option value="ddim_uniform">DDIM Uniform</option>
                            </select>
                            <small class="form-text text-muted">Recommended: @GetCurrentModelSet().RecommendedScheduler</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="denoise">
                                Denoise Strength
                                <i class="bi bi-question-circle tooltip-icon" title="Strength of denoising (0.0-1.0, 1.0 = full generation)"></i>
                            </label>
                            <input id="denoise" type="number" class="form-control" step="0.05" min="0.0" max="1.0" 
                                @bind="videoWrapper.Denoise" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Configuration Section -->
            <div class="parameter-section">
                <h5><i class="bi bi-file-earmark-video me-2"></i>Output Configuration</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="outputFormat">
                                Output Format
                                <i class="bi bi-question-circle tooltip-icon" title="Video output format"></i>
                            </label>
                            <select id="outputFormat" class="form-select" @bind="videoWrapper.OutputFormat">
                                <option value="auto">Auto</option>
                                <option value="mp4">MP4</option>
                                <option value="avi">AVI</option>
                                <option value="mov">MOV</option>
                                <option value="webm">WebM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="videoCodec">
                                Video Codec
                                <i class="bi bi-question-circle tooltip-icon" title="Video compression codec"></i>
                            </label>
                            <select id="videoCodec" class="form-select" @bind="videoWrapper.VideoCodec">
                                <option value="auto">Auto</option>
                                <option value="h264">H.264</option>
                                <option value="h265">H.265/HEVC</option>
                                <option value="vp9">VP9</option>
                                <option value="av1">AV1</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-primary" @onclick="QueueVideoGeneration" disabled="@isGenerating">
                    <i class="bi bi-play-fill me-2"></i>
                    @if (isGenerating)
                    {
                        <span>Generating...</span>
                    }
                    else
                    {
                        <span>Generate Video</span>
                    }
                </button>
                <button class="btn btn-outline-secondary" @onclick="ApplyModelDefaults">
                    <i class="bi bi-arrow-clockwise me-2"></i>Apply Model Defaults
                </button>
                <button class="btn btn-outline-secondary" @onclick="ResetParameters">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Reset All
                </button>
            </div>

            <!-- Multi-Field Ollama Reference -->
            @if (OutputState.ParsedOutput?.video != null && (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.positive_prompt) || !string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.negative_prompt)))
            {
                <div class="parameter-section">
                    <h5><i class="bi bi-layers me-2"></i>Structured Ollama Output</h5>
                    <div class="row">
                        @if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.positive_prompt))
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-success text-white py-2">
                                        <small><strong>Positive Prompt</strong> (@OutputState.ParsedOutput.video.positive_prompt.Length chars)</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <small>@OutputState.ParsedOutput.video.positive_prompt</small>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-success" @onclick="() => UsePositivePrompt()">
                                                <i class="bi bi-arrow-down me-1"></i>Use as Text Prompt
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.negative_prompt))
                        {
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-warning text-dark py-2">
                                        <small><strong>Negative Prompt</strong> (@OutputState.ParsedOutput.video.negative_prompt.Length chars)</small>
                                    </div>
                                    <div class="card-body py-2">
                                        <small>@OutputState.ParsedOutput.video.negative_prompt</small>
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-warning" @onclick="() => UseNegativePrompt()">
                                                <i class="bi bi-arrow-down me-1"></i>Use as Negative Prompt
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.positive_prompt) && !string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.negative_prompt))
                    {
                        <div class="text-center">
                            <button class="btn btn-primary" @onclick="UseAllVideoPrompts">
                                <i class="bi bi-download me-1"></i>Use All Video Prompts
                            </button>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Info Section -->
        <div class="col-lg-4">
            <div class="parameter-section">
                <h5><i class="bi bi-info-circle me-2"></i>Generation Info</h5>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Model Set:</strong> @GetCurrentModelSet().DisplayName</p>
                        <p><strong>Selected Audio:</strong> @(string.IsNullOrEmpty(videoWrapper.AudioFilePath) ? "None" : GetSelectedAudioName())</p>
                        <p><strong>Selected Image:</strong> @(string.IsNullOrEmpty(videoWrapper.ImageFilePath) ? "None" : GetSelectedImageName())</p>
                        <p><strong>Sampler:</strong> @videoWrapper.SamplerName (@videoWrapper.Scheduler)</p>
                        <p><strong>Steps:</strong> @videoWrapper.Steps | <strong>CFG:</strong> @videoWrapper.CFGScale</p>
                        <p><strong>Denoise:</strong> @videoWrapper.Denoise.ToString("F2")</p>
                        <p><strong>Resolution:</strong> @videoWrapper.Width x @videoWrapper.Height</p>
                        <p><strong>Video Length:</strong> @videoWrapper.VideoSegments segments x @videoWrapper.ChunkLength frames</p>
                        <p><strong>Total Frames:</strong> @videoWrapper.TotalFrames</p>
                        <p><strong>Batch Size:</strong> @videoWrapper.BatchSize</p>
                        <p class="mb-0"><strong>Estimated Duration:</strong> @GetEstimatedDuration() seconds @@ @videoWrapper.Fps FPS</p>
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Each video segment adds @videoWrapper.ChunkLength frames to the output. 
                        More segments = longer video but higher memory usage.
                    </small>
                </div>
                
                @if (GetCurrentModelSet().LoRAModel != null)
                {
                    <div class="alert alert-warning mt-3">
                        <small>
                            <i class="bi bi-lightning me-1"></i>
                            <strong>Lightning Model:</strong> This model set uses a LoRA for faster generation with fewer steps.
                            If quality is poor, try the 20-step model set without LoRA.
                        </small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private VideoWorkflowWrapper videoWrapper = new();
    private string? errorMessage;
    private bool isGenerating;
    private List<GeneratedFileInfo> audioFiles = new();
    private List<GeneratedFileInfo> imageFiles = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableFiles();

        // Subscribe to output state changes to update when new content is generated
        OutputState.Changed += StateHasChanged;

        // Initialize with Ollama visual description if available
        if (OutputState.ParsedOutput != null)
        {
            UseOllamaPrompt();
        }

        // Apply model set defaults on initialization
        videoWrapper.ApplyModelSetDefaults();
    }

    private async Task LoadAvailableFiles()
    {
        try
        {
            Logger.LogInformation("Loading available audio and image files from wwwroot");
            audioFiles = await FileService.GetAudioFilesAsync();
            imageFiles = await FileService.GetImageFilesAsync();
            Logger.LogInformation("Loaded {AudioCount} audio files and {ImageCount} image files", 
                audioFiles.Count, imageFiles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available files");
            audioFiles = new List<GeneratedFileInfo>();
            imageFiles = new List<GeneratedFileInfo>();
        }
    }

    private void OnModelSetChanged()
    {
        // Apply model set defaults when changed
        videoWrapper.ApplyModelSetDefaults();
        StateHasChanged();
    }

    private void ApplyModelDefaults()
    {
        videoWrapper.ApplyModelSetDefaults();
        StateHasChanged();
    }

    private ModelSetConfig GetCurrentModelSet()
    {
        return videoWrapper.GetCurrentModelSet();
    }

    private string GetCurrentModelInfo()
    {
        var modelSet = GetCurrentModelSet();
        return $"UNet: {modelSet.UNetModel}";
    }

    private float GetEstimatedDuration()
    {
        return (float)videoWrapper.TotalFrames / videoWrapper.Fps;
    }

    private void UseOllamaPrompt()
    {
        if (OutputState.ParsedOutput != null)
        {
            if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.visual_description))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.visual_description;
            }
            else if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.narrative))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.narrative;
            }

            if (OutputState.ParsedOutput.video_actions != null && OutputState.ParsedOutput.video_actions.Any())
            {
                videoWrapper.TextPrompt += "\n\nActions: " + string.Join(", ", OutputState.ParsedOutput.video_actions);
            }
            StateHasChanged();
        }
    }

    private void UsePositivePrompt()
    {
        if (OutputState.ParsedOutput?.video != null && !string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.positive_prompt))
        {
            videoWrapper.TextPrompt = OutputState.ParsedOutput.video.positive_prompt;
            StateHasChanged();
        }
    }

    private void UseNegativePrompt()
    {
        if (OutputState.ParsedOutput?.video != null && !string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.negative_prompt))
        {
            videoWrapper.NegativePrompt = OutputState.ParsedOutput.video.negative_prompt;
            StateHasChanged();
        }
    }

    private void UseAllVideoPrompts()
    {
        if (OutputState.ParsedOutput?.video != null)
        {
            if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.positive_prompt))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.video.positive_prompt;
            }

            if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.video.negative_prompt))
            {
                videoWrapper.NegativePrompt = OutputState.ParsedOutput.video.negative_prompt;
            }
        }

        StateHasChanged();
    }

    private void ResetParameters()
    {
        videoWrapper = new VideoWorkflowWrapper();
        videoWrapper.ApplyModelSetDefaults();
        StateHasChanged();
    }

    private string GetSelectedAudioName()
    {
        var file = audioFiles.FirstOrDefault(f => f.FilePath == videoWrapper.AudioFilePath);
        return file?.Name ?? "Unknown";
    }

    private string GetSelectedImageName()
    {
        var file = imageFiles.FirstOrDefault(f => f.FilePath == videoWrapper.ImageFilePath);
        return file?.Name ?? "Unknown";
    }

    private void OnImageSelectionChanged()
    {
        if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
        {
            var file = imageFiles.FirstOrDefault(f => f.FilePath == videoWrapper.ImageFilePath);
            if (file?.Width.HasValue == true && file?.Height.HasValue == true)
            {
                videoWrapper.Width = file.Width.Value;
                videoWrapper.Height = file.Height.Value;
                StateHasChanged();
            }
        }
    }

    private async Task QueueVideoGeneration()
    {
        isGenerating = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Queueing video generation: {Prompt}", videoWrapper.TextPrompt);

            var taskName = !string.IsNullOrWhiteSpace(videoWrapper.TextPrompt) && videoWrapper.TextPrompt.Length > 10
                ? videoWrapper.TextPrompt.Substring(0, Math.Min(50, videoWrapper.TextPrompt.Length))
                : "Video Generation";

            if (taskName.Length > 80)
                taskName = taskName.Substring(0, 77) + "...";

            var taskId = await VideoWorkflow.GenerateAsync(taskName, videoWrapper);

            await JSRuntime.InvokeVoidAsync("alert",
                $"Video generation queued successfully! Task ID: {taskId}\n\nYou can monitor progress in the Generation Queue page.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error queueing video generation");
            errorMessage = $"Failed to queue video generation: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        // Unsubscribe from output state changes
        OutputState.Changed -= StateHasChanged;
    }
}
