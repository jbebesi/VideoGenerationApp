@page "/generate-video"
@using static Microsoft.AspNetCore.Components.Web.RenderMode
@rendermode InteractiveServer
@using VideoGenerationApp.Services
@using VideoGenerationApp.Services.Generation
@using VideoGenerationApp.Dto
@inject VideoGenerationWorkflow VideoWorkflow
@inject IGeneratedFileService FileService
@inject IGenerationQueueService QueueService
@inject OllamaOutputState OutputState
@inject ILogger<GenerateVideo> Logger
@inject IJSRuntime JSRuntime
@inject Examples.GenerationWorkflowExample Example;
@implements IDisposable

<PageTitle>Generate Video - Video Generation App</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">
                <i class="bi bi-camera-video me-2"></i>
                Generate Video
            </h3>
        </div>
    </div>

    @if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Error:</strong> @errorMessage
        </div>
    }

    <div class="row">
        <div class="col-lg-8">
            <!-- Video Configuration Section -->
            <div class="parameter-section">
                <h5><i class="bi bi-camera-video me-2"></i>Video Generation Configuration</h5>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="modelSelect">
                                Checkpoint Model
                                <i class="bi bi-question-circle tooltip-icon" title="Select the checkpoint model to use for generation. Standard Stable Diffusion models work for image-to-image video generation."></i>
                            </label>
                            <select id="modelSelect" class="form-select" @bind="videoWrapper.CheckpointName" disabled="@isLoadingModels">
                                @if (isLoadingModels)
                                {
                                    <option disabled selected>Loading models...</option>
                                }
                                else if (availableModels == null || !availableModels.Any())
                                {
                                    <option disabled selected>No video models found</option>
                                }
                                else
                                {
                                    @foreach (var model in availableModels)
                                    {
                                        <option value="@model">@model</option>
                                    }
                                }
                            </select>
                            @if (availableModels != null && availableModels.Any())
                            {
                                <small class="form-text text-muted">@availableModels.Count model(s) available</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="textPrompt">
                                Text Prompt / Description
                                <i class="bi bi-question-circle tooltip-icon" title="Describe what should happen in the video"></i>
                            </label>
                            <textarea id="textPrompt" class="form-control" rows="4" @bind="videoWrapper.TextPrompt" 
                                placeholder="e.g., A serene landscape with moving clouds and gentle wind"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="negativePrompt">
                                Negative Prompt
                                <i class="bi bi-question-circle tooltip-icon" title="Describe what you don't want in the video"></i>
                            </label>
                            <textarea id="negativePrompt" class="form-control" rows="2" @bind="videoWrapper.NegativePrompt" 
                                placeholder="e.g., blurry, low quality, distorted, ugly"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="audioFile">
                                Audio File (optional)
                                <i class="bi bi-question-circle tooltip-icon" title="Select an audio file from previous generations"></i>
                            </label>
                            <select id="audioFile" class="form-control" @bind="videoWrapper.AudioFilePath">
                                <option value="">-- No Audio --</option>
                                @foreach (var file in audioFiles)
                                {
                                    <option value="@file.FilePath">@file.DisplayText</option>
                                }
                            </select>
                            @if (audioFiles.Any())
                            {
                                <small class="form-text text-muted">@audioFiles.Count audio file(s) available</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="imageFile">
                                Base Image (optional)
                                <i class="bi bi-question-circle tooltip-icon" title="Select an image file from previous generations"></i>
                            </label>
                            <select id="imageFile" class="form-control" @bind="videoWrapper.ImageFilePath" @bind:after="OnImageSelectionChanged">
                                <option value="">-- Generate from prompt --</option>
                                @foreach (var file in imageFiles)
                                {
                                    <option value="@file.FilePath">@file.DisplayText</option>
                                }
                            </select>
                            @if (imageFiles.Any())
                            {
                                <small class="form-text text-muted">@imageFiles.Count image file(s) available</small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="duration">
                                Duration (seconds)
                                <i class="bi bi-question-circle tooltip-icon" title="Length of the video in seconds"></i>
                            </label>
                            <input id="duration" type="number" class="form-control" step="0.5" min="1" max="120" 
                                @bind="videoWrapper.DurationSeconds" />
                            @if (!string.IsNullOrEmpty(videoWrapper.AudioFilePath))
                            {
                                <small class="form-text text-muted">
                                    Will match audio duration: @GetSelectedAudioDuration() seconds
                                </small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="width">
                                Width
                                <i class="bi bi-question-circle tooltip-icon" title="Video width in pixels"></i>
                            </label>
                            <input id="width" type="number" class="form-control" step="64" min="512" max="2048" 
                                @bind="videoWrapper.Width" />
                            @if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
                            {
                                <small class="form-text text-muted">
                                    Matches selected image width
                                </small>
                            }
                        </div>
                        
                        <div class="form-group">
                            <label for="height">
                                Height
                                <i class="bi bi-question-circle tooltip-icon" title="Video height in pixels"></i>
                            </label>
                            <input id="height" type="number" class="form-control" step="64" min="512" max="2048" 
                                @bind="videoWrapper.Height" />
                            @if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
                            {
                                <small class="form-text text-muted">
                                    Matches selected image height
                                </small>
                            }
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="fps">
                                FPS (Frames per Second)
                                <i class="bi bi-question-circle tooltip-icon" title="Video frame rate"></i>
                            </label>
                            <select id="fps" class="form-control" @bind="videoWrapper.Fps">
                                <option value="24">24 FPS (Film)</option>
                                <option value="30">30 FPS (Standard)</option>
                                <option value="60">60 FPS (Smooth)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="animationStyle">
                                Animation Style
                                <i class="bi bi-question-circle tooltip-icon" title="How the video should be animated"></i>
                            </label>
                            <select id="animationStyle" class="form-control" @bind="videoWrapper.AnimationStyle">
                                <option value="static">Static (minimal motion)</option>
                                <option value="smooth">Smooth (gentle movement)</option>
                                <option value="dynamic">Dynamic (active motion)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="motionIntensity">
                                Motion Intensity
                                <i class="bi bi-question-circle tooltip-icon" title="How much motion/animation (0.0 = none, 1.0 = maximum)"></i>
                            </label>
                            <input id="motionIntensity" type="number" class="form-control" step="0.1" min="0" max="1" 
                                @bind="videoWrapper.MotionIntensity" />
                        </div>
                        
                        <div class="form-group">
                            <label for="steps">
                                Generation Steps
                                <i class="bi bi-question-circle tooltip-icon" title="Number of denoising steps (higher = better quality, slower)"></i>
                            </label>
                            <input id="steps" type="number" class="form-control" min="1" max="100" 
                                @bind="videoWrapper.Steps" />
                        </div>
                        
                        <div class="form-group">
                            <label for="cfgScale">
                                CFG Scale
                                <i class="bi bi-question-circle tooltip-icon" title="How closely to follow the prompt (1-20)"></i>
                            </label>
                            <input id="cfgScale" type="number" class="form-control" step="0.5" min="1" max="20" 
                                @bind="videoWrapper.CFGScale" />
                        </div>
                        
                        <div class="form-group">
                            <label for="denoise">
                                Denoise Strength
                                <i class="bi bi-question-circle tooltip-icon" title="Strength of image-to-image transformation (0.0-1.0, higher = more change)"></i>
                            </label>
                            <input id="denoise" type="number" class="form-control" step="0.05" min="0.0" max="1.0" 
                                @bind="videoWrapper.Denoise" />
                        </div>
                        
                        <div class="form-group">
                            <label for="samplerName">
                                Sampler
                                <i class="bi bi-question-circle tooltip-icon" title="Sampling method used for generation"></i>
                            </label>
                            <select id="samplerName" class="form-select" @bind="videoWrapper.SamplerName">
                                <option value="euler">Euler</option>
                                <option value="euler_ancestral">Euler Ancestral</option>
                                <option value="heun">Heun</option>
                                <option value="dpm_2">DPM2</option>
                                <option value="dpm_2_ancestral">DPM2 Ancestral</option>
                                <option value="lms">LMS</option>
                                <option value="dpm_fast">DPM Fast</option>
                                <option value="dpm_adaptive">DPM Adaptive</option>
                                <option value="dpmpp_2s_ancestral">DPM++ 2S Ancestral</option>
                                <option value="dpmpp_sde">DPM++ SDE</option>
                                <option value="dpmpp_2m">DPM++ 2M</option>
                                <option value="ddim">DDIM</option>
                                <option value="uni_pc">UniPC</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="scheduler">
                                Scheduler
                                <i class="bi bi-question-circle tooltip-icon" title="Noise schedule used during generation"></i>
                            </label>
                            <select id="scheduler" class="form-select" @bind="videoWrapper.Scheduler">
                                <option value="normal">Normal</option>
                                <option value="karras">Karras</option>
                                <option value="exponential">Exponential</option>
                                <option value="sgm_uniform">SGM Uniform</option>
                                <option value="simple">Simple</option>
                                <option value="ddim_uniform">DDIM Uniform</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="quality">
                                Quality
                                <i class="bi bi-question-circle tooltip-icon" title="Video compression quality (0-100, higher = better)"></i>
                            </label>
                            <input id="quality" type="number" class="form-control" min="0" max="100" 
                                @bind="videoWrapper.Quality" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex gap-2 mb-4">
                <button class="btn btn-primary" @onclick="QueueVideoGeneration" disabled="@isGenerating">
                    <i class="bi bi-play-fill me-2"></i>
                    @if (isGenerating)
                    {
                        <span>Generating...</span>
                    }
                    else
                    {
                        <span>Generate Video</span>
                    }
                </button>
                <button class="btn btn-outline-secondary" @onclick="ResetParameters">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Reset to Defaults
                </button>
            </div>

            <!-- Ollama Scene Reference -->
            @if (OutputState.ParsedOutput != null)
            {
                <div class="parameter-section">
                    <h5><i class="bi bi-file-text me-2"></i>Ollama Scene Reference</h5>
                    <div class="card">
                        <div class="card-body">
                            <p><strong>Narrative:</strong> @OutputState.ParsedOutput.narrative</p>
                            <p><strong>Visual Description:</strong> @OutputState.ParsedOutput.visual_description</p>
                            <p><strong>Mood:</strong> @OutputState.ParsedOutput.tone (@OutputState.ParsedOutput.emotion)</p>
                            @if (OutputState.ParsedOutput.video_actions != null && OutputState.ParsedOutput.video_actions.Any())
                            {
                                <p><strong>Suggested Actions:</strong> @string.Join(", ", OutputState.ParsedOutput.video_actions)</p>
                            }
                            <button class="btn btn-sm btn-outline-primary" @onclick="UseOllamaPrompt">
                                <i class="bi bi-arrow-down me-1"></i>Use Scene as Prompt
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Info Section -->
        <div class="col-lg-4">
            <div class="parameter-section">
                <h5><i class="bi bi-info-circle me-2"></i>Info</h5>
                <div class="card">
                    <div class="card-body">
                        <p><strong>Selected Audio:</strong> @(string.IsNullOrEmpty(videoWrapper.AudioFilePath) ? "None" : GetSelectedAudioName())</p>
                        <p><strong>Selected Image:</strong> @(string.IsNullOrEmpty(videoWrapper.ImageFilePath) ? "None" : GetSelectedImageName())</p>
                        <p><strong>Model:</strong> @videoWrapper.CheckpointName</p>
                        <p><strong>Sampler:</strong> @videoWrapper.SamplerName (@videoWrapper.Scheduler)</p>
                        <p><strong>Steps:</strong> @videoWrapper.Steps | <strong>CFG:</strong> @videoWrapper.CFGScale</p>
                        <p><strong>Denoise:</strong> @videoWrapper.Denoise.ToString("F2")</p>
                        <p><strong>Estimated Duration:</strong> @videoWrapper.DurationSeconds seconds</p>
                        <p><strong>Resolution:</strong> @videoWrapper.Width x @videoWrapper.Height</p>
                        <p class="mb-0"><strong>Frame Rate:</strong> @videoWrapper.Fps FPS</p>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Generate audio and images first, then combine them here to create a complete video.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private VideoWorkflowWrapper videoWrapper = new();
    private string? errorMessage;
    private bool isGenerating;
    private bool isLoadingModels;
    private List<GeneratedFileInfo> audioFiles = new();
    private List<GeneratedFileInfo> imageFiles = new();
    private List<string> availableModels = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableFiles();

        // Initialize with Ollama visual description if available
        if (OutputState.ParsedOutput != null)
        {
            // Use visual_description for video generation (primary)
            if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.visual_description))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.visual_description;
            }
            // Fallback to narrative if visual_description is missing
            else if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.narrative))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.narrative;
            }
        }

        // Load available models
        await LoadAvailableModels();
    }

    private async Task LoadAvailableModels()
    {
        try
        {
            isLoadingModels = true;
            StateHasChanged();

            Logger.LogInformation("Loading available video models from ComfyUI via VideoWorkflow");

            // Get models from the video workflow which has access to ComfyUI services
            availableModels = await VideoWorkflow.GetAvailableModelsAsync();

            // If current checkpoint is not in the list and list is not empty, select the first one
            if (availableModels.Any() && !availableModels.Contains(videoWrapper.CheckpointName))
            {
                videoWrapper.CheckpointName = availableModels[0];
                Logger.LogInformation("Selected default video model: {Model}", videoWrapper.CheckpointName);
            }

            Logger.LogInformation("Loaded {Count} video models", availableModels.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available models");
            // Continue with default model if loading fails
        }
        finally
        {
            isLoadingModels = false;
            StateHasChanged();
        }
    }

    private async Task LoadAvailableFiles()
    {
        try
        {
            Logger.LogInformation("Loading available audio and image files from wwwroot");

            // Load files using the dedicated file service
            audioFiles = await FileService.GetAudioFilesAsync();
            imageFiles = await FileService.GetImageFilesAsync();

            Logger.LogInformation("Loaded {AudioCount} audio files and {ImageCount} image files", 
                audioFiles.Count, imageFiles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available files");
            // Continue with empty lists if loading fails
            audioFiles = new List<GeneratedFileInfo>();
            imageFiles = new List<GeneratedFileInfo>();
        }
    }

    private void UseOllamaPrompt()
    {
        if (OutputState.ParsedOutput != null)
        {
            // Use visual_description for video generation (primary)
            if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.visual_description))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.visual_description;
            }
            // Fallback to narrative if visual_description is missing
            else if (!string.IsNullOrWhiteSpace(OutputState.ParsedOutput.narrative))
            {
                videoWrapper.TextPrompt = OutputState.ParsedOutput.narrative;
            }
            else
            {
                videoWrapper.TextPrompt = "";
            }

            // Add video actions if available
            if (OutputState.ParsedOutput.video_actions != null && OutputState.ParsedOutput.video_actions.Any())
            {
                videoWrapper.TextPrompt += "\n\nActions: " + string.Join(", ", OutputState.ParsedOutput.video_actions);
            }
            StateHasChanged();
        }
    }

    private void ResetParameters()
    {
        videoWrapper = new VideoWorkflowWrapper();
        StateHasChanged();
    }

    private string GetSelectedAudioName()
    {
        var file = audioFiles.FirstOrDefault(f => f.FilePath == videoWrapper.AudioFilePath);
        return file?.Name ?? "Unknown";
    }

    private string GetSelectedImageName()
    {
        var file = imageFiles.FirstOrDefault(f => f.FilePath == videoWrapper.ImageFilePath);
        return file?.Name ?? "Unknown";
    }

    private void OnImageSelectionChanged()
    {
        // Auto-update video dimensions when image is selected
        if (!string.IsNullOrEmpty(videoWrapper.ImageFilePath))
        {
            var file = imageFiles.FirstOrDefault(f => f.FilePath == videoWrapper.ImageFilePath);
            if (file?.Width.HasValue == true && file?.Height.HasValue == true)
            {
                videoWrapper.Width = file.Width.Value;
                videoWrapper.Height = file.Height.Value;
                StateHasChanged();
            }
        }
    }

    private float GetSelectedAudioDuration()
    {
        var file = audioFiles.FirstOrDefault(f => f.FilePath == videoWrapper.AudioFilePath);
        if (file?.Duration.HasValue == true)
        {
            // Auto-update duration when audio is selected
            videoWrapper.DurationSeconds = (int)file.Duration.Value;
            return file.Duration.Value;
        }
        return videoWrapper.DurationSeconds;
    }

    private async Task QueueVideoGeneration()
    {
        isGenerating = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            // Update duration to match audio if audio is selected
            if (!string.IsNullOrEmpty(videoWrapper.AudioFilePath))
            {
                GetSelectedAudioDuration();
            }

            Logger.LogInformation("Queueing video generation: {Prompt}", videoWrapper.TextPrompt);

            // Generate a user-friendly name from the prompt
            var taskName = !string.IsNullOrWhiteSpace(videoWrapper.TextPrompt) && videoWrapper.TextPrompt.Length > 10
                ? videoWrapper.TextPrompt.Substring(0, Math.Min(50, videoWrapper.TextPrompt.Length))
                : "Video Generation";

            if (taskName.Length > 80)
                taskName = taskName.Substring(0, 77) + "...";

            // Use the new workflow service instead of the queue service directly - pass the wrapper
            var taskId = await VideoWorkflow.GenerateAsync(taskName, videoWrapper);

            //await Example.GenerateVideoExample();

            // Show success message
            await JSRuntime.InvokeVoidAsync("alert",
                $"Video generation queued successfully! Task ID: {taskId}\n\nYou can monitor progress in the Generation Queue page.");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error queueing video generation");
            errorMessage = $"Failed to queue video generation: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}
